<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>Chat | Chattrexx</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

      * {
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        height: 100%;
        overflow: hidden;
      }

      body {
        height: 100%;
        overflow: hidden;
        background: linear-gradient(to bottom right, #f8fafc, #e2e8f0);
      }

      body.dark {
        background: linear-gradient(to bottom right, #0f172a, #1e293b);
      }

      .app-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
      }

      .header {
        flex-shrink: 0;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      .input-container {
        flex-shrink: 0;
        padding-bottom: env(safe-area-inset-bottom, 0);
      }

      .message {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        transition: all 0.2s ease;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      }

      .btn-primary:active {
        transform: translateY(0);
      }

      .input-field {
        transition: all 0.2s ease;
      }

      .input-field:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Custom scrollbar */
      .messages-container::-webkit-scrollbar {
        width: 6px;
      }

      .messages-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      .dark .messages-container::-webkit-scrollbar-thumb {
        background: #475569;
      }

      /* iOS Safari specific fixes */
      @supports (-webkit-touch-callout: none) {
        .app-container {
          height: -webkit-fill-available;
        }
      }

      /* Prevent zoom on input focus on mobile */
      @media screen and (max-width: 768px) {
        input[type="text"] {
          font-size: 16px !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-container">
      <!-- Header -->
      <header
        class="header py-3 sm:py-4 bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700 shadow-sm"
      >
        <div class="max-w-6xl mx-auto flex justify-between items-center px-4">
          <div class="flex items-center gap-2">
            <svg
              class="w-6 h-6 sm:w-7 sm:h-7 flex-shrink-0"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#3b82f6" />
              <path
                d="M2 17L12 22L22 17V12L12 17L2 12V17Z"
                fill="#2563eb"
                opacity="0.7"
              />
            </svg>
            <h1
              class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white"
            >
              Chattrexx
            </h1>
          </div>
          <div class="flex items-center gap-2 sm:gap-3">
            <span
              id="welcome"
              class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 hidden sm:block truncate max-w-[100px] md:max-w-[200px]"
            ></span>
            <button
              id="logoutBtn"
              class="btn-primary px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg text-white text-xs sm:text-sm font-medium whitespace-nowrap"
            >
              Logout
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content max-w-6xl mx-auto w-full">
        <!-- Messages Area -->
        <div class="messages-container">
          <div id="messages" class="p-4 sm:p-6 space-y-3"></div>
        </div>

        <!-- Input Area -->
        <div
          class="input-container p-3 sm:p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"
        >
          <div class="flex gap-2">
            <input
              id="messageInput"
              type="text"
              placeholder="Type your message..."
              autocomplete="off"
              class="input-field flex-1 px-3 sm:px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white text-base"
            />
            <button
              id="sendBtn"
              type="button"
              tabindex="-1"
              class="btn-primary px-4 sm:px-6 py-2.5 rounded-lg text-white"
            >
              Send
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- FIREBASE CHAT LOGIC -->
    <script type="module">
      let shouldScrollAfterSend = false;
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        limit,
        onSnapshot,
        serverTimestamp,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDrQdx0vy_hDvb7jO3Z12YXrOFkl1Zl-jw",
        authDomain: "chattrexx.firebaseapp.com",
        projectId: "chattrexx",
        storageBucket: "chattrexx.firebasestorage.app",
        messagingSenderId: "23495067369",
        appId: "1:23495067369:web:8140a94606b45c81d6d278",
        measurementId: "G-5YKSCL74YK",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const messagesDiv = document.getElementById("messages");
      const messagesContainer = document.querySelector(".messages-container");
      const input = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const welcome = document.getElementById("welcome");

      let currentUser = null;

      // Auth guard
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "/login.html";
          return;
        }
        currentUser = user;
        welcome.textContent = user.displayName || user.email;
        listenForMessages();
      });

      // Real-time messages listener
      let isInitialLoad = true;

      function listenForMessages() {
        const q = query(
          collection(db, "messages"),
          orderBy("timestamp", "asc"),
          limit(100)
        );

        onSnapshot(q, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
              const data = change.doc.data();
              renderMessage(
                data.username,
                data.text,
                data.timestamp?.toDate().toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit",
                })
              );
            }
          });

          if (isInitialLoad) {
            scrollToBottom();
          } else if (shouldScrollAfterSend) {
            scrollToBottom();
            shouldScrollAfterSend = false;
          } else if (isUserAtBottom()) {
            // Someone else sent a message and user is already near bottom
            scrollToBottom();
          }

          isInitialLoad = false;
        });
      }

      // Check if user is at bottom of messages
      function isUserAtBottom() {
        const threshold = 100;
        return (
          messagesContainer.scrollHeight -
            messagesContainer.scrollTop -
            messagesContainer.clientHeight <
          threshold
        );
      }

      // Render message bubble
      function renderMessage(user, text, time) {
        const isSelf = user === (currentUser.displayName || currentUser.email);
        const div = document.createElement("div");
        div.className = `message ${isSelf ? "text-right" : "text-left"}`;

        const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

        div.innerHTML = `
      <div class="text-xs text-gray-500 dark:text-gray-400 mb-1 ${
        isSelf ? "mr-1" : "ml-1"
      }">
        ${user} ${time ? "â€¢ " + time : ""}
      </div>
      <div class="inline-block px-3 sm:px-4 py-2 sm:py-2.5 rounded-2xl max-w-[85%] sm:max-w-md lg:max-w-lg break-words shadow-sm ${
        isSelf
          ? "bg-gradient-to-r from-blue-500 to-blue-600 text-white"
          : "bg-white dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-200 dark:border-gray-600"
      }">
        ${sanitizedText}
      </div>
    `;

        messagesDiv.appendChild(div);
      }

      // Scroll to bottom helper
      function scrollToBottom() {
        requestAnimationFrame(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
      }
      async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        try {
          const FIFTEEN_DAYS = 15 * 24 * 60 * 60 * 1000;

          // Mark that this send came from the current user
          shouldScrollAfterSend = true;

          input.value = "";

          await addDoc(collection(db, "messages"), {
            text,
            username: currentUser.displayName || currentUser.email,
            timestamp: serverTimestamp(),
            expireAt: Timestamp.fromMillis(Date.now() + FIFTEEN_DAYS),
          });
        } catch (error) {
          console.error("Error sending message:", error);
          input.value = text;
          shouldScrollAfterSend = false;
        }
      }

      // Event listeners
      sendBtn.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        sendMessage();
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });

      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });

      // Logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            await signOut(auth);
            window.location.href = "/login.html";
          } catch (error) {
            console.error("Logout error:", error);
          }
        });
    </script>
  </body>
</html>
