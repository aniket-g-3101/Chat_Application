<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login | Chattrexx</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>

    <style>
      body {
        background: linear-gradient(to bottom right, #f8fafc, #e2e8f0);
      }
      body.dark {
        background: linear-gradient(to bottom right, #0f172a, #1e293b);
      }
      .card {
        background: white;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      }
      .dark .card {
        background: #1e293b;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }
      .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        transition: all 0.2s ease;
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      }
      .input-field {
        transition: all 0.2s ease;
      }
      .input-field:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      .google-btn {
        transition: all 0.2s ease;
      }
      .google-btn:hover {
        background: #f9fafb;
        border-color: #d1d5db;
      }
      .dark .google-btn:hover {
        background: #374151;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>

  <body
    class="flex items-center justify-center min-h-screen p-4 sm:px-6 lg:px-8"
  >
    <!-- Logo in top left corner -->
    <div class="fixed top-4 left-4 sm:top-6 sm:left-6 z-10">
      <div
        class="flex items-center gap-2 bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm px-3 py-2 sm:px-4 sm:py-2 rounded-full shadow-lg border border-gray-200 dark:border-gray-700"
      >
        <svg
          class="w-5 h-5 sm:w-6 sm:h-6"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#3b82f6" />
          <path
            d="M2 17L12 22L22 17V12L12 17L2 12V17Z"
            fill="#2563eb"
            opacity="0.7"
          />
        </svg>
        <span
          class="font-semibold text-gray-900 dark:text-white text-xs sm:text-sm"
          >Chattrexx</span
        >
      </div>
    </div>

    <div class="w-11/12 max-w-sm mx-auto">
      <div
        class="card rounded-2xl border border-gray-200 dark:border-gray-700 p-5 sm:p-7"
      >
        <h2
          class="text-xl sm:text-2xl font-semibold text-gray-900 dark:text-white mb-2"
        >
          Welcome back
        </h2>
        <p class="text-sm sm:text-base text-gray-600 dark:text-gray-400 mb-6">
          Sign in to continue
        </p>

        <!-- EMAIL LOGIN -->
        <form id="loginForm" class="space-y-4">
          <input
            id="email"
            type="email"
            required
            class="input-field w-full px-3 sm:px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white text-sm sm:text-base"
            placeholder="Email"
          />
          <input
            id="password"
            type="password"
            required
            class="input-field w-full px-3 sm:px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white text-sm sm:text-base"
            placeholder="Password"
          />

          <p id="errorMsg" class="text-xs sm:text-sm text-red-500 hidden"></p>

          <button
            type="submit"
            class="btn-primary w-full text-white py-2.5 rounded-lg font-medium text-sm sm:text-base"
          >
            Sign in
          </button>
        </form>

        <div class="my-6 flex items-center">
          <div
            class="flex-1 border-t border-gray-300 dark:border-gray-600"
          ></div>
          <span class="px-4 text-xs sm:text-sm text-gray-500">or</span>
          <div
            class="flex-1 border-t border-gray-300 dark:border-gray-600"
          ></div>
        </div>

        <!-- GOOGLE LOGIN -->
        <button
          id="googleLoginBtn"
          class="google-btn w-full flex items-center justify-center gap-2 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-800"
        >
          <img
            id="googleIcon"
            src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
            class="w-5 h-5"
          />
          <span
            id="googleBtnText"
            class="text-sm sm:text-base font-medium text-gray-700 dark:text-white"
            >Continue with Google</span
          >
        </button>

        <p
          class="text-center text-xs sm:text-sm text-gray-600 dark:text-gray-400 mt-6"
        >
          Don't have an account?
          <a
            href="/register.html"
            class="text-blue-600 dark:text-blue-400 font-medium hover:underline"
            >Sign up</a
          >
        </p>
      </div>
    </div>

    <!-- ðŸ”¥ FIREBASE AUTH -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

      // ðŸ”´ YOUR FIREBASE CONFIG
      const firebaseConfig = {
        apiKey: "AIzaSyDrQdx0vy_hDvb7jO3Z12YXrOFkl1Zl-jw",
        authDomain: "chattrexx.firebaseapp.com",
        projectId: "chattrexx",
        storageBucket: "chattrexx.firebasestorage.app",
        messagingSenderId: "23495067369",
        appId: "1:23495067369:web:8140a94606b45c81d6d278",
        measurementId: "G-5YKSCL74YK",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      const form = document.getElementById("loginForm");
      const errorMsg = document.getElementById("errorMsg");
      const googleLoginBtn = document.getElementById("googleLoginBtn");
      const googleIcon = document.getElementById("googleIcon");
      const googleBtnText = document.getElementById("googleBtnText");

      // HANDLE REDIRECT RESULT FIRST (MOBILE)
      async function handleRedirectResult() {
        try {
          const result = await getRedirectResult(auth);
          if (result?.user) {
            showLoading(true);
            await saveUser(result.user);
            window.location.href = "/chat.html";
          }
        } catch (err) {
          console.error("Redirect error:", err);
          errorMsg.textContent = err.message;
          errorMsg.classList.remove("hidden");
        }
      }

      // Check for redirect result on page load
      handleRedirectResult();

      // EMAIL LOGIN
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMsg.classList.add("hidden");

        try {
          await signInWithEmailAndPassword(auth, email.value, password.value);
          window.location.href = "/chat.html";
        } catch (err) {
          errorMsg.textContent = err.message;
          errorMsg.classList.remove("hidden");
        }
      });

      // GOOGLE LOGIN BUTTON
      googleLoginBtn.addEventListener("click", async () => {
        errorMsg.classList.add("hidden");
        
        try {
          if (isMobile) {
            showLoading(true);
            await signInWithRedirect(auth, provider);
          } else {
            showLoading(true);
            const result = await signInWithPopup(auth, provider);
            await saveUser(result.user);
            window.location.href = "/chat.html";
          }
        } catch (err) {
          showLoading(false);
          errorMsg.textContent = err.message;
          errorMsg.classList.remove("hidden");
        }
      });

      function showLoading(loading) {
        if (loading) {
          googleIcon.style.display = "none";
          googleBtnText.innerHTML = '<span class="loading"></span>';
          googleLoginBtn.disabled = true;
          googleLoginBtn.style.opacity = "0.6";
        } else {
          googleIcon.style.display = "block";
          googleBtnText.textContent = "Continue with Google";
          googleLoginBtn.disabled = false;
          googleLoginBtn.style.opacity = "1";
        }
      }

      async function saveUser(user) {
        try {
          await setDoc(
            doc(db, "users", user.uid),
            {
              username: user.displayName,
              email: user.email,
              photoURL: user.photoURL,
              provider: "google",
              lastLogin: new Date(),
            },
            { merge: true }
          );
        } catch (err) {
          console.error("Error saving user:", err);
        }
      }
    </script>
  </body>
</html>